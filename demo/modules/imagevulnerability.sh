#!/bin/bash

########################
# Image Vulnerability Security Demo Module
# Demonstrates the danger of deploying vulnerable container images
########################

shopt -s expand_aliases
alias k='kubecolor'

demo_imagevulnerability() {
    local MODULE_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
    local REPO_ROOT="$(dirname "$(dirname "$MODULE_DIR")")"
    local EXAMPLES_DIR="${REPO_ROOT}/imagevulnerability/examples"

    #############################################
    # SCENE 1: The Mistake (Broken)
    #############################################

    clear
    section_header "Image Vulnerability: The Mistake ðŸ’¥" "${RED}"
    echo

    # Change to examples directory
    cd "${EXAMPLES_DIR}"

    info "A pod is running in production with an old image..."
    echo
    pe "cat vulnerableimagepod.yaml"
    echo
    wait
    wait

    #############################################
    # SCENE 2: The Impact (What This Means)
    #############################################

    clear
    section_header "Image Vulnerability: Understanding the Impact ðŸ”" "${YELLOW}"
    echo
    info "Let's scan the curlimages/curl:7.82.0 image with Trivy..."
    info "This version of curl is End of Life (EOL) and no longer receives security updates"
    echo
    wait
    wait

    info "Running vulnerability scan..."
    echo
    pe "trivy image curlimages/curl:7.82.0 | grep -E '^(Total:)'"
    echo
    danger "ðŸ˜± Lots total vulnerabilities with several CRITICAL!"
    danger "Old EOL images accumulate hundreds of CVEs without security patches!"
    echo
    wait
    wait

    #############################################
    # SCENE 3: The Fix (Using Secure Images)
    #############################################

    clear
    section_header "Image Vulnerability: The Fix âœ…" "${GREEN}"
    echo
    success "Solution: Scan images BEFORE deployment and use updated base images"
    echo
    wait

    info "Let's scan a more recent version of the curl image with Trivy before applying..."
    echo
    pe "trivy image curlimages/curl:8.17.0@sha256:935d9100e9ba842cdb060de42472c7ca90cfe9a7c96e4dacb55e79e560b3ff40 | grep -E '^(Total:)'"
    echo
    success "âœ… Zero vulnerabilities with current image!"
    echo
    wait

    info "Now that we've scanned the image, let's update the pod to use curl 8.17.0..."
    echo
    pe "k set image pod/vulnerable-curl-demo curl-container=curlimages/curl:8.17.0@sha256:935d9100e9ba842cdb060de42472c7ca90cfe9a7c96e4dacb55e79e560b3ff40"
    echo
    success "Pod image updated to current curl version!"
    echo
    wait

    #############################################
    # Cleanup
    #############################################

    info "Cleaning up Image Vulnerability demo resources..."
    k delete pod vulnerable-node-demo --force --grace-period=0 --ignore-not-found=true &>/dev/null

    # Return to original directory
    cd - &>/dev/null
}
