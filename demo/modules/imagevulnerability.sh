#!/bin/bash

########################
# Image Vulnerability Security Demo Module
# Demonstrates the danger of deploying vulnerable container images
########################

shopt -s expand_aliases
alias k='kubecolor'

demo_imagevulnerability() {
    local MODULE_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
    local REPO_ROOT="$(dirname "$(dirname "$MODULE_DIR")")"
    local EXAMPLES_DIR="${REPO_ROOT}/imagevulnerability/examples"

    #############################################
    # SCENE 1: The Mistake (Broken)
    #############################################

    clear
    section_header "Image Vulnerability: The Mistake ðŸ’¥" "${RED}"
    echo

    # Change to examples directory
    cd "${EXAMPLES_DIR}"

    info "A pod is running in production with an old image..."
    echo
    pe "cat vulnerableimagepod.yaml"
    echo
    wait
    wait

    #############################################
    # SCENE 2: The Impact (What This Means)
    #############################################

    clear
    section_header "Image Vulnerability: Understanding the Impact ðŸ”" "${YELLOW}"
    echo
    info "Let's scan the node:10 image with Trivy..."
    info "Node.js 10 is End of Life (EOL) - no security updates since April 2021"
    echo
    wait
    wait

    info "Running vulnerability scan..."
    echo
    pe "trivy image node:10 --severity HIGH,CRITICAL 2>&1 | grep -E '^(Debian|Node\.js|Total:)'"
    echo
    danger "ðŸ˜± Lots total vulnerabilities with several CRITICAL!"
    danger "Old EOL images accumulate hundreds of CVEs without security patches!"
    echo
    wait
    wait

    #############################################
    # SCENE 3: The Attack (Simulated)
    #############################################

    clear
    section_header "Image Vulnerability: The Attack Scenario ðŸŽ­" "${RED}"
    echo
    danger "An attacker discovers you're running Node.js 10 (EOL since 2021)..."
    danger "They check public CVE databases for known exploits"
    danger "Hundreds of known vulnerabilities make this an easy target!"
    echo
    wait
    wait

    danger "Attack vectors with vulnerable images:"
    echo

    danger "Attack 1: Remote Code Execution (RCE)"
    echo
    info "  â€¢ CVEs in system libraries (glibc, openssl, etc.)"
    info "  â€¢ Attacker exploits vulnerability to run arbitrary code"
    info "  â€¢ Gains shell access to the container"
    echo
    wait

    danger "Attack 2: Privilege Escalation"
    echo
    info "  â€¢ Kernel vulnerabilities in base image"
    info "  â€¢ Container escape to host system"
    info "  â€¢ Full cluster compromise possible"
    echo
    wait

    danger "Attack 3: Supply Chain Attacks"
    echo
    info "  â€¢ Vulnerable dependencies in base image"
    info "  â€¢ Malicious packages exploiting known CVEs"
    info "  â€¢ Data exfiltration and persistence"
    echo
    wait

    danger "Attack 4: Automated Exploitation"
    echo
    info "  â€¢ Botnets scan for known vulnerable versions"
    info "  â€¢ Automated exploits within minutes of exposure"
    info "  â€¢ Cryptocurrency miners, backdoors, ransomware"
    echo
    danger "ðŸš¨ KNOWN VULNERABILITIES = OPEN DOORS FOR ATTACKERS ðŸš¨"
    echo
    wait
    sleep 1

    #############################################
    # SCENE 4: The Fix (Using Secure Images)
    #############################################

    clear
    section_header "Image Vulnerability: The Fix âœ…" "${GREEN}"
    echo
    success "Solution: Scan images BEFORE deployment and use updated base images"
    echo
    info "Best practices:"
    echo "  â€¢ Scan images in CI/CD pipeline (block vulnerable images)"
    echo "  â€¢ Use recent base image versions"
    echo "  â€¢ Regularly update and rebuild images"
    echo "  â€¢ Use minimal base images (alpine, distroless)"
    echo "  â€¢ Enable admission controllers to enforce policies"
    echo
    wait

    info "Let's update the pod to use Node.js 20 Alpine (current LTS with minimal base)..."
    echo
    pe "k set image pod/vulnerable-node-demo node-container=node:20-alpine"
    echo
    success "Pod image updated to current Node LTS on minimal Alpine base!"
    echo
    wait

    info "Let's scan this current image..."
    echo
    pe "trivy image node:20-alpine --severity HIGH,CRITICAL 2>&1 | grep -E '^(Alpine|Node\.js|Total:)'"
    echo
    success "âœ… Zero HIGH/CRITICAL vulnerabilities with current image!"
    echo
    wait
    sleep 1

    #############################################
    # SCENE 5: The Result (Verification)
    #############################################

    clear
    section_header "Image Vulnerability: Verifying the Fix ðŸ”’" "${GREEN}"
    echo
    success "Let's compare both images side by side..."
    echo

    info "EOL image (node:10) - No security updates since April 2021:"
    echo
    pe "trivy image node:10 --severity CRITICAL 2>&1 | grep -E '^Total:'"
    echo
    wait

    info "Current image (node:20-alpine) - Active security support + minimal base:"
    echo
    pe "trivy image node:20-alpine --severity CRITICAL 2>&1 | grep -E '^Total:'"
    echo
    success "âœ… Massive reduction: 79 CRITICAL â†’ 0 CRITICAL!"
    success "âœ… Alpine base provides minimal attack surface!"
    echo
    wait

#    clear
#    section_header "Image Vulnerability: Summary ðŸ“‹" "${CYAN}"
#    echo
#    success "âœ… Scanned images for known vulnerabilities"
#    success "âœ… Identified 478 total CVEs (79 CRITICAL) in node:10"
#    success "âœ… Updated pod to use node:20-alpine with 0 CRITICAL CVEs"
#    success "âœ… Used minimal Alpine base for reduced attack surface"
#    echo
#    success "ðŸŽ¯ Image vulnerabilities detected and mitigated!"
#    success "   Regular scanning prevents running EOL images with hundreds of CVEs"
#    echocls
#    wait

    #############################################
    # Cleanup
    #############################################

#    info "Cleaning up Image Vulnerability demo resources..."
#    k delete pod vulnerable-node-demo --force --grace-period=0 --ignore-not-found=true &>/dev/null

    # Return to original directory
    cd - &>/dev/null
}
